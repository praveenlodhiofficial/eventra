generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

model User {
  id          String  @id @default(cuid())
  name        String?
  email       String  @unique
  password    String
  phoneNumber String?
  role        Role    @default(USER)

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventCategory {
  id     String  @id @default(cuid())
  name   String  @unique
  slug   String  @unique

  events Event[] @relation("EventCategories")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventImage {
  id       String @id @default(cuid())
  url      String
  
  eventId  String
  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

model Event {
  id          String @id @default(cuid())
  name        String
  slug        String @unique
  description String
  
  coverImage  String
  images       EventImage[]

  categories  EventCategory[] @relation("EventCategories")
  performers Performer[] @relation("EventPerformers")

  city     String
  status EventStatus @default(DRAFT)

  ticketTypes TicketType[]

  startAt DateTime
  endAt   DateTime

  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startAt])
  @@index([venueId])
}

model Performer {
  id    String  @id @default(cuid())
  name  String
  slug  String @unique
  image String
  bio   String
  role  String 

  events Event[] @relation("EventPerformers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Venue {
  id      String @id @default(cuid())
  name    String
  address String
  city    String
  state   String
  country String
  pincode String

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TicketStatus {
  RESERVED
  PAID
  CANCELLED
  REFUNDED
  SCANNED
}

model TicketType {
  id       String  @id @default(cuid())
  name     String
  price    Decimal @db.Decimal(10,2)
  quantity Int

  eventId  String
  event    Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@unique([eventId, name])
}


model Ticket {
  id        String @id @default(cuid())

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])

  // optional seating
  seatNumber String?
  section    String?
  row        String?

  quantity Int @default(1)

  status TicketStatus @default(RESERVED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([ticketTypeId])

  // prevents same seat from being sold twice
  @@unique([ticketTypeId, seatNumber, row, section])
}
